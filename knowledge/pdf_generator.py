"""
PDFç”Ÿæˆå™¨
å°†ç»“æ„åŒ–å†…å®¹ç”Ÿæˆä¸ºPDFæ–‡æ¡£
ä½¿ç”¨ fpdf2 åº“ï¼Œæ”¯æŒä¸­æ–‡
"""
from fpdf import FPDF
from pathlib import Path
from typing import List, Optional
from datetime import datetime

from ..models import StructuredContent, LegalSection
from ..config import Config


class ChinesePDF(FPDF):
    """æ”¯æŒä¸­æ–‡çš„PDFç±»"""

    def __init__(self):
        super().__init__()
        self.set_auto_page_break(auto=True, margin=15)

    def header(self):
        """é¡µçœ‰"""
        if self.page_no() == 1:
            return  # é¦–é¡µä¸æ˜¾ç¤ºé¡µçœ‰

        self.set_font('helvetica', '', 9)
        self.set_text_color(128, 128, 128)
        # ä½¿ç”¨è‹±æ–‡é¿å…å­—ä½“é—®é¢˜
        self.cell(0, 10, 'Legal Rights Knowledge Base', 0, 0, 'L')
        self.ln(15)

    def footer(self):
        """é¡µè„š"""
        self.set_y(-15)
        self.set_font('helvetica', '', 8)
        self.set_text_color(128, 128, 128)
        page_text = f'Page {self.page_no()}/{{nb}}'
        self.cell(0, 10, page_text, 0, 0, 'C')

    def chapter_title(self, title: str, level: int = 1):
        """ç« èŠ‚æ ‡é¢˜"""
        # æ ¹æ®å±‚çº§è®¾ç½®å­—ä½“å¤§å°
        sizes = {1: 16, 2: 14, 3: 12, 4: 11, 5: 10, 6: 10}
        size = sizes.get(level, 10)

        # æ·»åŠ å‚ç›´é—´è·
        if level == 1:
            self.ln(10)
        elif level == 2:
            self.ln(8)
        else:
            self.ln(5)

        self.set_font('helvetica', 'B', size)
        self.set_text_color(0, 0, 0)

        # æ·»åŠ æ ‡é¢˜å‰ç¼€ï¼ˆå±‚çº§ç¼©è¿›ï¼‰
        indent = '  ' * (level - 1)
        self.multi_cell(0, 8, f'{indent}{title}')
        self.ln(3)

    def chapter_body(self, text: str):
        """ç« èŠ‚å†…å®¹"""
        if not text or not text.strip():
            return

        self.set_font('helvetica', '', 10)
        self.set_text_color(50, 50, 50)

        # åˆ†æ®µå¤„ç†
        paragraphs = text.split('\n\n')
        for para in paragraphs:
            para = para.strip()
            if para:
                self.multi_cell(0, 6, para)
                self.ln(3)


class PDFGenerator:
    """PDFç”Ÿæˆå™¨"""

    def __init__(self):
        """åˆå§‹åŒ–ç”Ÿæˆå™¨"""
        self.output_dir = Config.KNOWLEDGE_DIR

    def _sanitize_filename(self, title: str) -> str:
        """æ¸…ç†æ–‡ä»¶å"""
        # ç§»é™¤ä¸å…è®¸çš„å­—ç¬¦
        invalid_chars = '<>:"/\\|?*'
        for char in invalid_chars:
            title = title.replace(char, '')

        # é™åˆ¶é•¿åº¦
        if len(title) > 50:
            title = title[:50]

        return title.strip()

    def generate(
        self,
        content: StructuredContent,
        output_path: Optional[Path] = None
    ) -> Path:
        """
        ç”ŸæˆPDFæ–‡æ¡£

        Args:
            content: ç»“æ„åŒ–å†…å®¹
            output_path: è¾“å‡ºè·¯å¾„ï¼ˆå¦‚æœä¸ºNoneåˆ™è‡ªåŠ¨ç”Ÿæˆï¼‰

        Returns:
            ç”Ÿæˆçš„PDFæ–‡ä»¶è·¯å¾„
        """
        # ç¡®å®šè¾“å‡ºè·¯å¾„
        if output_path is None:
            filename = self._sanitize_filename(content.title) + '.pdf'
            output_path = self.output_dir / filename

        print(f"ğŸ“„ ç”ŸæˆPDF: {content.title}")
        print(f"   è¾“å‡º: {output_path}")

        # åˆ›å»ºPDF
        pdf = ChinesePDF()
        pdf.add_page()

        # è®¾ç½®é»˜è®¤å­—ä½“
        pdf.set_font('helvetica', '', 10)

        # ç”Ÿæˆå°é¢
        self._add_cover_page(pdf, content)

        # ç”Ÿæˆç›®å½•
        self._add_toc_page(pdf, content)

        # ç”Ÿæˆå†…å®¹é¡µ
        self._add_content_pages(pdf, content)

        # ä¿å­˜PDF
        pdf.output(str(output_path))

        file_size = output_path.stat().st_size
        print(f"   âœ… ç”Ÿæˆå®Œæˆ ({file_size:,} å­—èŠ‚)")

        return output_path

    def _add_cover_page(self, pdf: ChinesePDF, content: StructuredContent):
        """æ·»åŠ å°é¢é¡µ"""
        pdf.set_font('helvetica', 'B', 24)
        pdf.ln(60)
        pdf.cell(0, 20, content.title, 0, 1, 'C')

        pdf.set_font('helvetica', '', 12)
        pdf.set_text_color(100, 100, 100)
        pdf.ln(10)

        # å…ƒæ•°æ® (ä½¿ç”¨è‹±æ–‡é¿å…å­—ä½“é—®é¢˜)
        pdf.cell(0, 8, f'Source: {content.url}', 0, 1, 'C')
        pdf.cell(0, 8, f'Date: {content.scraped_at.strftime("%Y-%m-%d")}', 0, 1, 'C')
        pdf.cell(0, 8, f'Sections: {len(content.sections)}', 0, 1, 'C')

        pdf.ln(20)
        pdf.set_font('helvetica', '', 10)
        pdf.multi_cell(
            0, 6,
            'Generated by Legal Rights AI Assistant\n'
            'For reference only - Please consult professional lawyers',
            0, 'C'
        )

        # æ·»åŠ æ–°é¡µ
        pdf.add_page()

    def _add_toc_page(self, pdf: ChinesePDF, content: StructuredContent):
        """æ·»åŠ ç›®å½•é¡µ"""
        pdf.set_font('helvetica', 'B', 18)
        pdf.cell(0, 15, 'Table of Contents', 0, 1, 'C')
        pdf.ln(10)

        pdf.set_font('helvetica', '', 10)

        def add_section_to_toc(section: LegalSection, level: int):
            """é€’å½’æ·»åŠ ç« èŠ‚åˆ°ç›®å½•"""
            indent = '  ' * (level - 1)
            prefix = '-' * level

            # ç« èŠ‚æ ‡é¢˜
            pdf.set_text_color(0, 0, 0)
            title_text = f'{indent}{prefix} {section.title}'
            pdf.multi_cell(0, 6, title_text)

            # é€’å½’å¤„ç†å­ç« èŠ‚
            for subsection in section.subsections:
                add_section_to_toc(subsection, level + 1)

        for section in content.sections:
            add_section_to_toc(section, 1)

        pdf.add_page()

    def _add_content_pages(self, pdf: ChinesePDF, content: StructuredContent):
        """æ·»åŠ å†…å®¹é¡µ"""

        def add_section(section: LegalSection):
            """é€’å½’æ·»åŠ ç« èŠ‚å†…å®¹"""
            # æ·»åŠ æ ‡é¢˜
            pdf.chapter_title(section.title, section.level)

            # æ·»åŠ å†…å®¹
            if section.content:
                pdf.chapter_body(section.content)

            # é€’å½’å¤„ç†å­ç« èŠ‚
            for subsection in section.subsections:
                add_section(subsection)

        for section in content.sections:
            add_section(section)

    def generate_batch(
        self,
        contents: List[StructuredContent]
    ) -> List[Path]:
        """
        æ‰¹é‡ç”ŸæˆPDF

        Args:
            contents: ç»“æ„åŒ–å†…å®¹åˆ—è¡¨

        Returns:
            ç”Ÿæˆçš„PDFæ–‡ä»¶è·¯å¾„åˆ—è¡¨
        """
        print(f"\nğŸ“š æ‰¹é‡ç”Ÿæˆ {len(contents)} ä¸ªPDFæ–‡æ¡£")
        print("=" * 70)

        output_paths = []

        for i, content in enumerate(contents, 1):
            print(f"\n[{i}/{len(contents)}]")
            try:
                path = self.generate(content)
                output_paths.append(path)
            except Exception as e:
                print(f"   âŒ ç”Ÿæˆå¤±è´¥: {e}")

        print("\n" + "=" * 70)
        print(f"âœ… å®Œæˆ: æˆåŠŸ {len(output_paths)}/{len(contents)}")

        return output_paths
